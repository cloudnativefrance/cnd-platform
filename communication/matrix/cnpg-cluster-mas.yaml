apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: cnpg-mas
spec:
  description: "MAS CNPG"
  instances: 2
  bootstrap:
    initdb:
      database: mas
      owner: mas
      secret:
        name: mas-cnpg-secret

  superuserSecret:
    name: mas-cnpg-secret

  postgresql:
    parameters:
      effective_cache_size: "384MB"
      work_mem: "8MB"
      maintenance_work_mem: "128MB"
      autovacuum_vacuum_scale_factor: "0.05"
      autovacuum_analyze_scale_factor: "0.025"
      autovacuum_vacuum_cost_delay: "2ms"
      tcp_keepalives_idle: "10"
      tcp_keepalives_interval: "10"
      tcp_keepalives_count: "3"

  storage:
    storageClass: node-local-retain
    size: 10Gi

  backup:
    barmanObjectStore:
      destinationPath: "s3://cloudnativedaysfr/cnpg/mas"
      endpointURL: "https://s3.fr-par.scw.cloud"
      s3Credentials:
        accessKeyId:
          name: cnd-france-scw-secret
          key: accesskey
        secretAccessKey:
          name: cnd-france-scw-secret
          key: secretkey
        region:
          name: cnd-france-scw-secret
          key: region
      wal:
        compression: gzip
      data:
        compression: gzip
    retentionPolicy: "90d"

  monitoring:
    customQueriesConfigMap:
      - key: queries
        name: cnpg-default-monitoring
    disableDefaultQueries: false
    enablePodMonitor: true
    podMonitorMetricRelabelings:
      - action: replace
        sourceLabels:
          - cluster
        targetLabel: cnpg_cluster
      - action: labeldrop
        regex: cluster

  resources:
    requests:
      memory: "768Mi"
      cpu: 200m
    limits:
      memory: "768Mi"
